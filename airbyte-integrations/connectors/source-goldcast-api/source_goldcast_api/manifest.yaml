version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: []

  requester:
    type: HttpRequester
    url_base: "https://customapi.goldcast.io"
    http_method: "GET"
    authenticator:
      type: ApiKeyAuthenticator
      header: "Authorization"
      api_token: "Token {{ config['access_key'] }}"

  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: NoPagination
    requester:
      $ref: "#/definitions/requester"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"

  organizations_stream:
    $ref: "#/definitions/base_stream"
    name: "organizations"
    description: "Organizations stream. Events are the base object of Goldcast."
    primary_key: "id"
    $parameters:
      path: "/core/organization/"

  events_stream:
    $ref: "#/definitions/base_stream"
    name: "events"
    description: "Events stream. Events are the base object of Goldcast."
    primary_key: "id"
    $parameters:
      path: "/event/"

  agenda_items_stream:
    $ref: "#/definitions/base_stream"
    name: "agenda_items"
    description: "Agenda items stream. Agenda items are associated to events."
    primary_key: "id"
    $parameters:
      path: "/event/agenda-item/"

  discussion_groups_stream:
    $ref: "#/definitions/base_stream"
    name: "discussion_groups"
    description: "Discussion groups stream. Discussion groups of events."
    primary_key: "id"
    $parameters:
      path: "/event/discussion-groups/"

  tracks_stream:
    $ref: "#/definitions/base_stream"
    name: "tracks"
    description: "Tracks stream. Tasks of events."
    primary_key: "id"
    $parameters:
      path: "/event/tracks/"

  webinars_stream:
    $ref: "#/definitions/base_stream"
    name: webinars
    description: "Webinars stream. Information on the webinars of events."
    primary_key: "id"
    $parameters:
      partition_router:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - type: ParentStreamConfig
              parent_key: id
              partition_field: event
              stream:
                $ref: '#/definitions/events_stream'
      path: "/event/webinars/{{ stream_partition.event }}"

  event_members_stream:
    $ref: "#/definitions/base_stream"
    name: event_members
    description: "Events members stream. Information on who particpated on events."
    primary_key: "id"
    $parameters:
      partition_router:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - type: ParentStreamConfig
              parent_key: id
              partition_field: event
              stream:
                $ref: '#/definitions/events_stream'
      path: "/event/event-members?event={{ stream_partition.event }}"

  event_agenda_stream:
    $ref: "#/definitions/base_stream"
    name: event_agenda
    description: "Events agenda stream. Information on what was the agenda of a spcific event."
    primary_key: "id"
    $parameters:
      partition_router:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - type: ParentStreamConfig
              parent_key: id
              partition_field: event
              stream:
                $ref: '#/definitions/events_stream'
      selector:
        extractor:
          field_path: ["broadcast"]
      path: "/event/{{ stream_partition.event }}/agenda/"

#  session_attendance_stream:
#    $ref: "#/definitions/base_stream"
#    name: session_attendance
#    description: "Session attendance stream. Information on who attendend what session of an event."
#    primary_key: "id"
#    $parameters:
#      partition_router:
#        - type: SubstreamPartitionRouter
#          parent_stream_configs:
#            - type: ParentStreamConfig
#              parent_key: id
#              partition_field: session
#              stream:
#                $ref: '#/definitions/event_agenda_stream'
#      path: "/event/get_session_attendance/?session={{ stream_partition.session }}"
      

streams:
  - "#/definitions/organizations_stream"
  - "#/definitions/events_stream"
  - "#/definitions/agenda_items_stream"
  - "#/definitions/discussion_groups_stream"
  - "#/definitions/tracks_stream"
  - "#/definitions/webinars_stream"
  - "#/definitions/event_members_stream"
  - "#/definitions/event_agenda_stream"
#  - "#/definitions/session_attendance_stream"

check:
  type: CheckStream
  stream_names:
    - "events"
    - "agenda_items"
    - "organizations"
    - "discussion_groups"
    - "tracks"
    - "webinars"
    - "event_members"
    - "event_agenda"
#    - "session_attendance"

spec: 
  documentation_url: https://customapi.goldcast.io/swagger-ui/#/
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: goldcast.io Source Spec
    type: object
    required:
      - access_key
    additionalProperties: true
    properties:
      access_key:
        type: string
        description: >-
          Your API Access Key. See <a
          href="https://help.goldcast.io/hc/en-us/articles/22931655725723-How-To-Create-an-API-Token-in-Goldcast">here</a>. The key is
          case sensitive.
        airbyte_secret: true
